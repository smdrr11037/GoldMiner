# 中期总结

---------

## 每轮迭代情况说明（model补充在后面

- 第一轮迭代：window 实现三个窗口之间的切换，实现鼠标点击按键交互和分数等Label的显示。在 ViewModel 中加入 `Timer`，创建独立线程每隔固定时间间隔发送类似中断信号。
- 第二轮迭代：window 实现游戏中界面显示单个金块和钩子图片，初步实现绘制线条功能，并实现游戏中界面与键盘的交互。在 Model 中实现各数据的初始化，建立 Model 与 ViewModel 的信号槽连接。
- 第三轮迭代：可以根据指针暴露的 `Blocks` 属性画出地图上的所有金块，实现钩子正确旋转以及绳子与钩子末端的连接。完善 Model 层功能，包括关卡初始化、钩子与物块的移动、接收与发送信号等等，可以成功进行一轮简易游戏。
- 第四轮迭代：优化UI界面，调整参数，使游戏界面更顺畅合理。更改框架，令 Model 成为 ViewModel 的成员，数据传递改用共享指针进行暴露而非信号槽传递，将 `Timer` 与 `gameState` 转交 View 层管理。

## 技术难点及克服

### 框架搭建过程中的困难

1. Qt 框架下如何实现数据绑定

### view 层实现过程遇到的困难

1. Qt 库的使用
以前没有接触过 Qt 库，刚开始使用时显得很生涩，好在Qt库的使用并非十分困难，代码撰写过程中慢慢熟练了。
2. 不同窗口之间的切换
起初实现窗口切换时采用三个窗口分别 `setCentralWidget` ，但在想要再次显示已显示窗口时应该是由于 `setCentralWidget` 函数的性质，会导致程序发生段错误而异常退出；
后续采用 `stackedWidget` 来实现不同窗口的切换。
3. 布局管理器的使用
需要 `layout->addStretch(1)` 添加弹簧，将按钮推到底部，否则页面布局会非常迥异。
4. 绘制线条（绳子）的实现
起初想尝试用 Qt 库 `QGraphicsLineItem` 来实现绘制线条，但绘制出来的线条总是会携带画布，覆盖我的游戏界面；
最后采用重写 `QWidget` 的 `paintEvent` 函数的方法，在现有的布局管理器中添加一条线，而不会在布局中留下额外的空白区域。
5. 键盘交互
起初交互过程中出现无法响应键盘的情况，通过 `setFocusPolicy`(`Qt::StrongFocus`) 设置部件（`widget`）的焦点，用户可以直接与部件进行交互，而不需要额外的操作来激活部件的焦点。
6. 刷新页面时多个金块的重复显示刷新页面重绘所有金块和石块时，会出现“重影”，即上一次画的没有被擦除；增加 `clearBlocks` 函数，每次刷新页面时先调用 `clearBlocks` 擦除上次显示的金块。
7. 钩子旋转和绳子连接

起初一直未能依靠 Qt 库函数实现：

- `Hook` 的旋转
- 旋转之后有一部分钩子图像无法正常显示
- `Hook` 图片旋转后钩子末端坐标改变，使得“绳子连接到钩子末端”变得难以实现

解决方法：

1. 创建一个新的 `QPixmap`，用于旋转后的图像
```c++
QPixmap rotatedPixmap(w, h);
rotatedPixmap.fill(Qt::transparent);
QPainter painter(&rotatedPixmap);
painter.setRenderHint(QPainter::Antialiasing, true);
```
2. 将绘图原点平移到钩子末端处
```c++
painter.translate(w/2, h / 4);
```
3. 进行旋转
```c++
painter.rotate(rotationAngle);
```
4. 绘制旋转后的图像
```c++
painter.drawPixmap(0, 0, hookImage);
painter.end();
```
5. 最后根据 `Hook` 坐标绘制线条，实现绳子和钩子的无缝连接。

### model 层实现过程遇到的困难

1. 起初想要自己造定时器轮子耗费了大量时间，之后阅读官方文档发现 Qt 已经提供了 `QTimer` 类，使用后发现效果更佳。
2. 花费了一定时间理解了信号槽的机制，在项目中大量使用，之后发现应当精简信号，更不应通过信号传递数据，而共享指针更适合本项目的数据传递。
3. 在最初的理解中分离了 Model 与 ViewModel，但在实际操作中发现两者的联系更为紧密，因此在后续迭代中将 Model 作为 ViewModel 的成员，ViewModel 并不向 Model 传递信号，而是直接调用 Model 的 `public` 方法，并且能够接收 Model 的信号。

## 协作情况

前四轮迭代中，我们的分工如下

薛柔：搭建项目框架，负责 App 层
姚懿宸：负责 View 层和 Window 层
朱熙哲：负责 Model 层和 ViewModel 层

## 部分效果图

## 总体心得

## 个人心得

### 朱熙哲

1. 在项目中应当尽量避免自己造轮子，遇到实现问题可以先查询官方文档寻找帮助。
2. 需要理解 MVVM 模式不同层间的联系，考虑各种传递信息的方法，选择最适合的方法或者结合使用，以提高代码的可读性和可维护性，还有程序的性能。
